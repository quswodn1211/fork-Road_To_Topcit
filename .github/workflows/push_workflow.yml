name: Backend API Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  api-test:
    runs-on: ubuntu-latest

    steps:
      # 1. ÏÜåÏä§ Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout
        uses: actions/checkout@v3

      # 2. Docker Compose Version
      - name: Docker Compose Version
        run: docker compose version

      # 3. Backend Ïã§Ìñâ
      - name: Start Backend with RDS
        run: docker compose up -d --build backend
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://topcit-db.cjg2aaai646f.ap-northeast-2.rds.amazonaws.com:3306/topcit
          SPRING_DATASOURCE_USERNAME: admin
          SPRING_DATASOURCE_PASSWORD: topcit1234

      # 4. Backend Ï§ÄÎπÑ ÎåÄÍ∏∞ + Ïã§Ìå® Ïãú Î°úÍ∑∏ Ï∂úÎ†•
      - name: Wait for Backend
        run: |
          echo "‚è≥ Waiting for backend..."
          for i in {1..60}; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/api/subjects || true)
            if [ "$STATUS" = "200" ]; then
              echo "üéâ Backend is UP!"
              exit 0
            fi
            echo "Backend not ready (HTTP $STATUS)... retrying"
            sleep 3
          done

          echo "‚ùå Backend FAILED"
          docker ps -a
          docker logs backend
          exit 1

      ###########################################################
      #                    GET ONLY TESTS
      ###########################################################

      - name: 1) GET /api/subjects
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/api/subjects)
          echo "Status: $STATUS"
          test $STATUS -eq 200

      - name: 2) GET /api/questions/1
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/api/questions/1)
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 3) GET /api/questions?subject=1
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" "http://localhost:8080/api/questions?subject=1")
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # Ï¢ÖÎ£å
      - name: Shutdown Docker
        if: always()
        run: docker compose down
