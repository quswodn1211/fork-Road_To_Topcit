name: Backend API Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  api-test:
    runs-on: ubuntu-latest

    steps:
      # 1. ÏÜåÏä§ Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout
        uses: actions/checkout@v3

      # 2. Docker Compose Î≤ÑÏ†Ñ ÌôïÏù∏
      - name: Docker Compose Version
        run: docker compose version

      # 3. Backend Ïã§Ìñâ (AWS RDS ÏÇ¨Ïö©)
      - name: Start Backend with RDS
        run: |
          docker compose up -d --build
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://topcit-db.cjg2aaai646f.ap-northeast-2.rds.amazonaws.com:3306/topcit
          SPRING_DATASOURCE_USERNAME: admin
          SPRING_DATASOURCE_PASSWORD: topcit1234

      # 4. Backend Ï§ÄÎπÑ ÎåÄÍ∏∞ + Ïã§Ìå® Ïãú ÏûêÎèô Î°úÍ∑∏ Ï∂úÎ†•
      - name: Wait for Backend
        run: |
          echo "‚è≥ Waiting for backend to start..."

          for i in {1..60}; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/api/subjects)
            if [ "$STATUS" -eq 200 ]; then
              echo "üéâ Backend is UP!"
              exit 0
            fi
            echo "Backend not ready yet (HTTP $STATUS)... retrying ($i/60)"
            sleep 3
          done

          echo "‚ùå Backend failed to start after 60 attempts."

          echo "---- Docker Containers ----"
          docker ps -a || true

          echo "---- Detecting backend container ----"
          BACKEND_CONTAINER=$(docker ps -a --format "{{.Names}}" | grep "backend" || true)
          echo "Detected backend container: $BACKEND_CONTAINER"

          echo "---- Backend Logs ----"
          docker logs $BACKEND_CONTAINER || true

          exit 1

      ###########################################################
      #                      API FUNCTION TESTS                 #
      ###########################################################

      - name: 1) GET /api/subjects
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" http://localhost:8080/api/subjects)
          echo "Status: $STATUS"
          test $STATUS -eq 200

      - name: 2) POST /api/questions
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" \
            -X POST http://localhost:8080/api/questions \
            -H "Content-Type: application/json" \
            -d '{"title":"test", "content":"data", "subjectId":1}')
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 3) GET /api/questions/1
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" http://localhost:8080/api/questions/1)
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 4) GET /api/questions?subject=1
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" "http://localhost:8080/api/questions?subject=1")
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 5) POST /api/questions/ai-generate
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" \
            -X POST http://localhost:8080/api/questions/ai-generate \
            -H "Content-Type: application/json" \
            -d '{"prompt":"Ïö¥ÏòÅÏ≤¥Ï†ú Ïä§ÏºÄÏ§ÑÎßÅ ÏÑ§Î™Ö"}')
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 6) POST /api/attempts
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" \
            -X POST http://localhost:8080/api/attempts \
            -H "Content-Type: application/json" \
            -d '{"questionId":1, "answer":"ÎãµÎ≥Ä"}')
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 7) GET /api/attempts/question/1
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" http://localhost:8080/api/attempts/question/1)
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 8) GET /api/attempts/my
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" http://localhost:8080/api/attempts/my)
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 9) GET /api/recommend/weakness
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" http://localhost:8080/api/recommend/weakness)
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 10) GET /api/recommend/today
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" http://localhost:8080/api/recommend/today)
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 11) POST /api/chat
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" \
            -X POST http://localhost:8080/api/chat \
            -H "Content-Type: application/json" \
            -d '{"message":"ÏïàÎÖï"}')
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 12) GET /api/essence?subjectId=1
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" "http://localhost:8080/api/essence?subjectId=1")
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 13) GET /api/essence/1
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" "http://localhost:8080/api/essence/1")
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 14) GET /api/weekly-plan?weekStart=2025-01-01
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" \
            "http://localhost:8080/api/weekly-plan?weekStart=2025-01-01")
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 15) PUT /api/weekly-plan
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" \
            -X PUT http://localhost:8080/api/weekly-plan \
            -H "Content-Type: application/json" \
            -d '{"weekStart":"2025-01-01","planItems":[]}')
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      - name: 16) POST /api/weekly-plan/ai-generate
        run: |
          STATUS=$(curl -o /null -s -w "%{http_code}" \
            -X POST http://localhost:8080/api/weekly-plan/ai-generate \
            -H "Content-Type: application/json" \
            -d '{"prompt":"Ïª¥Ìì®ÌÑ∞Íµ¨Ï°∞ Í≥µÎ∂Ä"}')
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # Docker Ï¢ÖÎ£å
      - name: Shutdown Docker
        if: always()
        run: docker compose down
