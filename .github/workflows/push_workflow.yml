name: Backend API Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  api-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Docker Compose Version
        run: docker compose version

      - name: Start Backend with RDS
        run: docker compose up -d --build backend
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://topcit-db.cjg2aaai646f.ap-northeast-2.rds.amazonaws.com:3306/topcit
          SPRING_DATASOURCE_USERNAME: admin
          SPRING_DATASOURCE_PASSWORD: topcit1234

      - name: Wait for Backend
        run: |
          echo "⏳ Waiting for backend..."
          for i in {1..60}; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/api/subjects || true)
            if [ "$STATUS" = "200" ]; then
              echo "Backend is UP!"
              exit 0
            fi
            echo "Backend not ready (HTTP $STATUS)... retrying"
            sleep 3
          done

          echo "❌ Backend FAILED"
          docker ps -a
          echo "---- LOGS ----"
          docker logs $(docker ps -aq --filter "name=backend")
          exit 1
