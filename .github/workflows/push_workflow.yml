name: Backend API Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  api-test:
    runs-on: ubuntu-latest

    steps:
      # 1. 체크아웃
      - name: Checkout
        uses: actions/checkout@v3

      # 2. Docker Compose 버전 출력
      - name: Docker Compose Version
        run: docker compose version

      # 3. backend + mysql 실행
      - name: Start Backend & DB
        run: |
          docker compose up -d backend mysql

      # 4. backend 준비될 때까지 대기 (최대 40초)
      - name: Wait for Backend
        run: |
          echo "⏳ Waiting for backend to start..."
          for i in {1..40}; do
            if curl -s http://localhost:8080/api/subjects > /dev/null; then
              echo "Backend is UP!"
              exit 0
            fi
            echo "Backend not ready yet... retrying"
            sleep 2
          done
          echo "Backend did not start in time"
          docker logs backend
          exit 1

      ###########################################################
      #                  API FUNCTION TESTS (16개)               #
      ###########################################################

      # -------------------------
      # 1. 과목 전체 조회
      # -------------------------
      - name: 1) GET /api/subjects
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/api/subjects)
          echo "Status: $STATUS"
          test $STATUS -eq 200

      # -------------------------
      # 2. 문제 생성
      # -------------------------
      - name: 2) POST /api/questions
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" \
            -X POST http://localhost:8080/api/questions \
            -H "Content-Type: application/json" \
            -d '{"title":"test question", "content":"some content", "subjectId":1}')
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 3. 문제 상세 조회
      # -------------------------
      - name: 3) GET /api/questions/1
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/api/questions/1)
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 4. 특정 과목 문제 조회
      # -------------------------
      - name: 4) GET /api/questions?subject=1
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" "http://localhost:8080/api/questions?subject=1")
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 5. AI 문제 생성
      # -------------------------
      - name: 5) POST /api/questions/ai-generate
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" \
            -X POST http://localhost:8080/api/questions/ai-generate \
            -H "Content-Type: application/json" \
            -d '{"prompt":"운영체제 스케줄링 설명해줘"}')
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 6. 풀이 제출
      # -------------------------
      - name: 6) POST /api/attempts
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" \
            -X POST http://localhost:8080/api/attempts \
            -H "Content-Type: application/json" \
            -d '{"questionId":1, "answer":"답변"}')
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 7. 문제별 내 풀이 조회
      # -------------------------
      - name: 7) GET /api/attempts/question/1
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/api/attempts/question/1)
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 8. 내 풀이 전체 조회
      # -------------------------
      - name: 8) GET /api/attempts/my
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/api/attempts/my)
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 9. 약점 분석
      # -------------------------
      - name: 9) GET /api/recommend/weakness
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/api/recommend/weakness)
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 10. 오늘의 학습 추천
      # -------------------------
      - name: 10) GET /api/recommend/today
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8080/api/recommend/today)
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 11. AI 챗봇 메시지 처리
      # -------------------------
      - name: 11) POST /api/chat
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" \
            -X POST http://localhost:8080/api/chat \
            -H "Content-Type: application/json" \
            -d '{"message":"안녕"}')
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 12. 예습 목록 조회
      # -------------------------
      - name: 12) GET /api/essence?subjectId=1
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" "http://localhost:8080/api/essence?subjectId=1")
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 13. 예습 상세 조회
      # -------------------------
      - name: 13) GET /api/essence/1
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" "http://localhost:8080/api/essence/1")
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 14. 주간 계획 조회
      # -------------------------
      - name: 14) GET /api/weekly-plan?weekStart=2025-01-01
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" "http://localhost:8080/api/weekly-plan?weekStart=2025-01-01")
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 15. 주간 계획 저장
      # -------------------------
      - name: 15) PUT /api/weekly-plan
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" \
            -X PUT http://localhost:8080/api/weekly-plan \
            -H "Content-Type: application/json" \
            -d '{"weekStart":"2025-01-01","planItems":[]}')
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      # -------------------------
      # 16. 주간 계획 AI 생성
      # -------------------------
      - name: 16) POST /api/weekly-plan/ai-generate
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" \
            -X POST http://localhost:8080/api/weekly-plan/ai-generate \
            -H "Content-Type: application/json" \
            -d '{"prompt":"컴퓨터구조 공부 계획"}')
          echo "Status: $STATUS"
          test $STATUS -ge 200 && test $STATUS -lt 500

      ###########################################################

      # 17. 종료
      - name: Shutdown Docker
        if: always()
        run: docker compose down
